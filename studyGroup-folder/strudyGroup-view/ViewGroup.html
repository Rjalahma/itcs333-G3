<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>View Study Group</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="ViewGroup.css" rel="stylesheet">
    <link href="../StudyGroup.css" rel="stylesheet">
</head>
<body>
    <!-- Header -->
    <header>
        <div class="container">
            <h1>Campus Hub</h1>
        </div>
    </header>

    <!-- Navbar -->
    <nav class="navbar navbar-expand-lg navbar-dark">
        <div class="container-fluid">
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav"
                aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav">
                    <li class="nav-item">
                        <a class="nav-link" href="..\..\index.html">Home</a>
                    </li>
                    <li class="nav-item active">
                        <a class="nav-link" href="#">Study Group Finder <span class="sr-only"></span></a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="..\..\Shahad-Reviews\CourseReviews.html">Course Reviews</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="..\..\course_note_folder\course-note-main.html">Course Notes </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="..\..\marwa project\campusNews.html">Campus News</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="..\..\club-activites_folder\Club_Activities\Club_Activities.html">Club Activities</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="..\..\StudentMarketplace-folder\product\index.html">Student Marketplace</a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <main class="container py-5">
        <a href="../studyGroup-finder/pro.html" class="btn btn-secondary previous">&laquo; Previous</a>
        
        <!-- Loading Indicator -->
        <div id="loader" class="text-center" style="display: none;">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
        </div>

        <!-- Error Message -->
        <div id="errorMessage" class="alert alert-danger mt-3" style="display: none;" role="alert"></div>

        <div class="view-page-container row">
            <!-- Group Details Card -->
            <div class="col-md-6">
                <div class="details-card p-4 shadow-sm rounded">
                    <h2 class="details-card-header">Group Details</h2>
                
                    <!-- Group Name -->
                    <div class="details-card-title">Group Name</div>
                    <p class="details-card p" id="groupName"></p>
                    
                    <!-- Description Section -->
                    <div class="details-card-title">Description</div>
                    <p class="details-card p" id="description"></p>
                    
                    <!-- Subject Code -->
                    <div class="details-card-title">Subject Code</div>
                    <p class="details-card p" id="subjectCode"></p>
                    
                    <!-- Academic Year -->
                    <div class="details-card-title">Academic Year</div>
                    <p class="details-card p" id="year"></p>
                    
                    <!-- Location of Study Session -->
                    <div class="details-card-title">Location of Study Session</div>
                    <p class="details-card p" id="location"></p>
                    
                    <!-- Group Members -->
                    <div class="details-card-title">Group Members</div>
                    <p class="details-card p" id="members"></p>
                    
                    <!-- Creator of the Group -->
                    <div class="details-card-title">Creator of the Group</div>
                    <p class="details-card p" id="creator"></p>
        
                    <!-- Join Button -->
                    <button class="btn btn-secondary w-100 mt-2" id="joinButton"onclick="joinGroup('${group.id}')">Join Group</button>
                    <button class="btn btn-danger w-100 mt-2" id="deleteButton" onclick="deleteGroup()">Delete Group</button>
                    <div class="row mt-2" id="creatorActions" style="display: none;">
                        <div class="col-md-6">
              
                        </div>
                    </div>
                </div>
            </div>

            <!-- Comment Section Card -->
            <div class="col-md-6">
                <div class="comment-card p-4 shadow-sm rounded">
                    <div class="comment-card-header">

                        <h3>Comment Section</h3>
                    </div>
        
                    <!-- Existing Comments -->
                    <div id="commentsContainer"></div>

                    <!-- Comment Posting -->
                    <div class="mt-4">
                   
                      
                        <form id="commentForm">
                            <textarea class="form-control" id="newComment"rows="3" name="newComment" placeholder="Add your comment..." required></textarea>
                            <button type="submit" class="btn btn-secondary w-100 mt-2" >Post Comment</button>
                        </form>

                        <div id="successMessage" style="display: none;">Comment posted successfully!</div>
                        <div id="errorMessage" style="display: none;">Failed to post comment!</div>

                        <!-- <div id="commentsContainer"> -->
                            <!-- Existing comments will be displayed here -->
                        <!-- </div> -->


                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
    <script src="../studyGroup-finder/pro.js"></script>
    <script>
        // Get group data from sessionStorage
        const groupData = JSON.parse(sessionStorage.getItem('selectedGroup'));
        
        if (groupData) {
            // Populate group details
    
            document.getElementById('groupName').textContent = groupData.groupName;
            document.getElementById('description').textContent = groupData.description;
            document.getElementById('subjectCode').textContent = groupData.subjectCode;
            document.getElementById('year').textContent = groupData.year;
            document.getElementById('location').textContent = groupData.location;
            document.getElementById('members').textContent = `${groupData.members.length}/${groupData.maxMembers}`;
            document.getElementById('creator').textContent = groupData.creatorEmail;

            // Show/hide creator actions
            const currentUser = 'current.user@example.com'; // In a real app, this would come from user session
            if (groupData.creatorEmail === currentUser) {
                document.getElementById('creatorActions').style.display = 'flex';
                document.getElementById('joinButton').style.display = 'none';
            }

            // Render comments
            const commentsContainer = document.getElementById('commentsContainer');
            
            console.log('group',groupData.comments);
            commentsContainer.innerHTML = groupData.comments.map(comment => `
                <p class="comment-card p">
                    <strong>${comment.user_name}:</strong> ${comment.message}
                    <small class="text-muted d-block">
                        ${new Date(comment.posted_at).toLocaleString()}
                    </small>
                </p>
            `).join('');
        } else {
            document.getElementById('errorMessage').textContent = 'Group not found';
            document.getElementById('errorMessage').style.display = 'block';
        }

        
// Post comment function
    async function postComment(event) {
        // event.preventDefault(); 

        const newComment = document.getElementById('newComment').value;
        if (!newComment.trim()) {
            alert("Please enter a comment.");
            return;  // Prevent posting empty comments
        }

        try {
            showLoader(); // Show loading spinner

            const commentData = {
                groupId: groupData.groupId,  // Use actual group ID
                userName: 'User', // This should come from the logged-in user's session
                message: newComment, // Get comment text from the form input
            };

            // Send the comment to the server
            const response = await fetch(Comment_API_URL, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(commentData),
            });

            const result = await response.json();
            if (!response.ok || result.error) {
                throw new Error('Failed to post comment');
            }

            // Show success message
            document.getElementById('successMessage').style.display = 'block';

            // Append the new comment to the UI dynamically
            const commentsContainer = document.getElementById('commentsContainer');
            const commentElement = document.createElement('p');
            commentElement.className = 'comment-card p';
            commentElement.innerHTML = `
                <strong>${commentData.userName}:</strong> ${commentData.message}
                <small class="text-muted d-block">Just now</small>
            `;
            commentsContainer.appendChild(commentElement);

            // Clear the input field after posting
            document.getElementById('newComment').value = '';

        } catch (error) {
            showError('Failed to post comment');
            console.error('Error:', error);
        } finally {
            hideLoader(); // Hide the loader when the operation is complete
        }
    }

    // Attach the event listener to the comment form
    document.getElementById('commentForm').addEventListener('submit', postComment);


        const urlparams=new URLSearchParams(window.location.search)   ;
        const GID= urlparams.get('id')    ;
        console.log('thissssss',GID);
        // Delete group function
async function deleteGroup() {
    if (!confirm('Are you sure you want to delete this group? This action cannot be undone.')) {
        return;
    }

    try {
        const response = await fetch('https://add62c0c-c8b3-495c-a225-79ebd85c094b-00-2h8t6ky89z6bv.pike.replit.dev/deleteGroup.php', {
            method: 'DELETE',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ id: GID })
        });

        console.log(response);  // Log the response object to see its status
        const textResponse = await response.text();  // Attempt to read the response as text (for debugging)
        console.log('Raw response:', textResponse);  // Log the raw response to see what is returned from PHP

            // If delete was successful, log the response
            console.log('Success:', data);

            // Notify the user and reload the page
            alert('Item deleted successfully!');
            window.location.replace('../studyGroup-finder/pro.html');  // Redirect to another page
      

    } catch (error) {
        console.error('Error:', error);
        alert('the group got deleted successfully ');
    }

    window.location.replace('../studyGroup-finder/pro.html');
}

        
    </script>
</body>
</html>

    